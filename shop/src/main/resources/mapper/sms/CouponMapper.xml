<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.learn.shop.dao.sms.CouponDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.learn.shop.entity.sms.CouponEntity">
        <id column="id" property="id"/>
        <result column="type" property="type"/>
        <result column="name" property="name"/>
        <result column="platform" property="platform"/>
        <result column="count" property="count"/>
        <result column="amount" property="amount"/>
        <result column="per_limit" property="perLimit"/>
        <result column="min_point" property="minPoint"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="use_type" property="useType"/>
        <result column="note" property="note"/>
        <result column="publish_count" property="publishCount"/>
        <result column="use_count" property="useCount"/>
        <result column="receive_count" property="receiveCount"/>
        <result column="enable_time" property="enableTime"/>
        <result column="code" property="code"/>
        <result column="member_level" property="memberLevel"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, type, name, platform, count, amount, per_limit, min_point, start_time, end_time, use_type, note, publish_count, use_count, receive_count, enable_time, code, member_level
    </sql>

    <select id="getPageCouponList" resultType="com.learn.shop.vo.sms.CouponVo">
        select c.id,
        c.name,
        c.type,
        c.use_type as useType,
        c.min_point as minPoint,
        c.amount,
        c.platform,
        c.start_time as startTime,
        c.end_time as endTime,
        if(c.end_time - now() > 0, '有效', '已过期') as status
        from sms_coupon c
        where c.delete_status = 0
        <if test="param.name !=null and param.name !=''">
            and c.name like concat('%',#{param.name,jdbcType=VARCHAR},'%')
        </if>
        <if test="param.type!=null">
            and c.type = #{param.type,jdbcType=INTEGER}
        </if>
    </select>
    <select id="getCouponById" resultType="com.learn.shop.vo.sms.CouponInfoVo">
        select sc.name,
               sc.type,
               sc.use_type                              as useType,
               sc.min_point                             as minPoint,
               sc.amount,
               if(sc.end_time - now() > 0, '有效', '已过期') as status,
               sc.start_time                            as startTime,
               sc.end_time                              as endTime,
               sc.publish_count                         as publishCount,
               sc.receive_count                         as receiveCount,
               sc.publish_count - receive_count         as toReceive,
               sc.use_count                             as useCount,
               sc.publish_count - sc.use_count          as unusedCount
        from sms_coupon sc
        where sc.id = #{id}
    </select>

</mapper>
